<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>M5Stack FS90R Controller</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: #eee; }
    button { width: 90px; height: 90px; margin: 6px; font-size: 20px; }
    #pad { display: grid; grid-template-columns: repeat(3, 100px); justify-content: center; margin: 20px auto; }
    #pad button { background:#444; border-radius:12px; border:none; color:#fff; }
    #pad button.armed { background:#666; }
    #pad button.active { background:#0a84ff; }
    #stop { margin-top:20px; background:#c00; color:#fff; font-size:22px; padding:15px 40px; border-radius:10px; }
    #spd { width: 60%; margin: 20px; }
  </style>
</head>
<body>
  <h2>FS90R BLE Controller</h2>
  <button onclick="connect()">üîó Connect</button>
  <div id="pad">
    <div></div><button id="btnUp">‚Üë</button><div></div>
    <button id="btnLeft">‚Üê</button><div></div><button id="btnRight">‚Üí</button>
    <div></div><button id="btnDown">‚Üì</button><div></div>
  </div>
  <button id="btnStop">STOP</button>
  <div>
    Speed: <input type="range" id="spd" min="30" max="100" value="70">
  </div>
  <div id="log"></div>

  <script>
  const SERVICE_UUID  = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const CHAR_RW_UUID  = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
  const LONG_MS   = 200;
  const REPEAT_MS = 150;

  let device, server, service, charRW;
  let activeSending = false;

  function log(msg){ document.getElementById('log').innerText = msg; }

  async function connect(){
    try{
      device = await navigator.bluetooth.requestDevice({filters:[{services:[SERVICE_UUID]}]});
      server = await device.gatt.connect();
      service = await server.getPrimaryService(SERVICE_UUID);
      charRW = await service.getCharacteristic(CHAR_RW_UUID);
      log("Connected");
    }catch(e){ log("Connect error: " + e); }
  }

  async function send(x, y){
    if(!charRW) return;
    const sp = Number(document.getElementById("spd").value)|0;
    const b = new Uint8Array(3);
    b[0] = (x<<24)>>24;
    b[1] = (y<<24)>>24;
    b[2] = sp;
    try{ await charRW.writeValueWithoutResponse(b); }
    catch(e){ log("write err: " + e); }
  }

  function bindLongPress(btn, vec){
    let pressTimer = null;
    let repeatTimer = null;
    let armed = false;

    const clearAll = ()=>{
      if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; }
      if (repeatTimer){ clearInterval(repeatTimer); repeatTimer=null; }
      if (armed){ btn.classList.remove('active'); armed=false; }
      activeSending = false;
      btn.classList.remove('armed');
    };

    const start = (e)=>{
      e.preventDefault();
      btn.classList.add('armed');
      pressTimer = setTimeout(async ()=>{
        armed = true;
        btn.classList.remove('armed');
        btn.classList.add('active');
        if (navigator.vibrate) navigator.vibrate(10);
        activeSending = true;
        await send(vec[0], vec[1]);
        repeatTimer = setInterval(()=> {
          if (activeSending) send(vec[0], vec[1]);
        }, REPEAT_MS);
      }, LONG_MS);
    };

    const end = (e)=>{
      e.preventDefault();
      clearAll();
    };

    btn.addEventListener("touchstart", start);
    btn.addEventListener("mousedown", start);
    btn.addEventListener("touchend", end);
    btn.addEventListener("mouseup", end);
    btn.addEventListener("mouseleave", end);
  }

  bindLongPress(document.getElementById("btnUp"),    [0,  100]);
  bindLongPress(document.getElementById("btnDown"),  [0, -100]);
  bindLongPress(document.getElementById("btnLeft"),  [-100, 0]);
  bindLongPress(document.getElementById("btnRight"), [100,  0]);

  document.getElementById('btnStop').onclick = ()=> { activeSending=false; send(0,0); };

  // „Ç¢„Ç§„Éâ„É´ÊôÇ„ÅÆ„Éè„Éº„Éà„Éì„Éº„Éà„ÅßÁ¢∫ÂÆüÂÅúÊ≠¢
  setInterval(()=> { if (charRW && !activeSending) send(0,0); }, REPEAT_MS);
  </script>
</body>
</html>
