<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>M5 4-Way RC (Simple)</title>
<style>
  :root { --gap:12px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif; background:#0b0b0c; color:#fff; }
  header { position: sticky; top:0; background:#111; padding:12px 16px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #222; z-index:10; }
  header h1 { font-size:16px; margin:0; flex:1; color:#d7e7ff; }
  main { padding:16px; max-width:500px; margin:0 auto; }
  .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:var(--gap); }
  .btn { background:#1c1d22; color:#fff; border:none; border-radius:14px; padding:18px; font-size:22px; width:100%; height:92px; box-shadow:0 2px 0 rgba(255,255,255,.04) inset, 0 1px 8px rgba(0,0,0,.4); touch-action:none; }
  .btn:active { transform: translateY(1px); }
  .btn.red { background:#b91c1c; height:auto; padding:14px 18px; }
  .card { background:#0f1115; border:1px solid #1e2330; border-radius:14px; padding:14px; }
  .label { display:flex; justify-content:space-between; font-size:14px; color:#aab4cf; margin-bottom:6px; }
  input[type=range]{ width:100%; }
</style>
</head>
<body>
<header>
  <h1>M5 4-Way RC</h1>
  <button id="btnConnect" class="btn">🔗 接続</button>
  <button id="btnStop" class="btn red">⛔ 停止</button>
</header>

<main>
  <div class="card" style="margin-bottom:14px;">
    <div class="label"><span>速度</span><span><b id="spdVal">60</b>%</span></div>
    <input id="speed" type="range" min="30" max="100" value="60">
  </div>

  <div class="grid">
    <div></div><button id="up" class="btn">↑</button><div></div>
    <button id="left" class="btn">←</button><div></div><button id="right" class="btn">→</button>
    <div></div><button id="down" class="btn">↓</button><div></div>
  </div>

  <div style="margin-top:14px;" class="card">
    <div style="font-size:13px; line-height:1.6">
      状態: <b id="status">未接続</b>
    </div>
  </div>
</main>

<script>
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHAR_RW_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

let device, server, service, charRW;
let holdTimer = null; // 押下中の再送タイマー
let holding = false;  // 何かの方向を押し続けているか
const REPEAT_MS = 120; // 押下中の再送間隔（短めでキビキビ）

const statusEl = document.getElementById('status');
const spdEl = document.getElementById('speed');
const spdVal = document.getElementById('spdVal');
spdEl.addEventListener('input', ()=> spdVal.textContent = spdEl.value);

function setStatus(s){ statusEl.textContent = s; }

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({ filters:[{ services:[SERVICE_UUID] }] });
    device.addEventListener('gattserverdisconnected', ()=> setStatus("未接続"));
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    charRW = await service.getCharacteristic(CHAR_RW_UUID);
    setStatus("接続中");
  }catch(e){ setStatus("接続失敗"); console.error(e); }
}

// 3バイト: [x(int8), y(int8), speed(uint8)]
async function send(x, y){
  if(!charRW) return;
  const sp = Number(spdEl.value)|0;
  const b = new Uint8Array(3);
  b[0] = (x<<24)>>24;  // int8
  b[1] = (y<<24)>>24;  // int8
  b[2] = sp;           // 0..100
  try { await charRW.writeValueWithoutResponse(b); } catch(e){ console.error(e); }
}

function bindHold(btn, vec){
  const start = (e)=>{
    e.preventDefault();
    // 押下開始：即送 & 再送ループ開始
    holding = true;
    send(vec[0], vec[1]);
    if (holdTimer) clearInterval(holdTimer);
    holdTimer = setInterval(()=> { if (holding) send(vec[0], vec[1]); }, REPEAT_MS);
  };
  const end = (e)=>{
    e.preventDefault();
    // 離したら即停止送信＆ループ解除
    holding = false;
    if (holdTimer){ clearInterval(holdTimer); holdTimer=null; }
    send(0,0);
  };
  // pointer系のみ（多重発火防止）
  btn.addEventListener('pointerdown', start, {passive:false});
  btn.addEventListener('pointerup',   end,   {passive:false});
  btn.addEventListener('pointerleave',end,   {passive:false});
  btn.addEventListener('pointercancel',end,  {passive:false});
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnStop').onclick = ()=>{ holding=false; if (holdTimer){clearInterval(holdTimer); holdTimer=null;} send(0,0); };

bindHold(document.getElementById('up'),    [ 0, +100 ]);
bindHold(document.getElementById('down'),  [ 0, -100 ]);
bindHold(document.getElementById('left'),  [ -100,  0 ]);
bindHold(document.getElementById('right'), [ +100,  0 ]);
</script>
</body>
</html>
