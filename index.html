<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>M5 4-Way RC</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 16px; }
  #log { font-size: 12px; white-space: pre-wrap; background: #f5f5f5; padding:8px; border-radius:8px; }
  .row { display:flex; gap:12px; justify-content:center; margin:8px 0; }
  button { flex:1; padding:18px; font-size:20px; border-radius:12px; }
  #grid { max-width: 420px; margin: 0 auto; }
  .wide { font-size:18px; padding:14px; }
  input[type=range] { width: 100%; }
  .label { display:flex; justify-content:space-between; font-size:14px; }
</style>
</head>
<body>
<h2>M5 4-Way RC</h2>

<div id="grid">
  <div class="row">
    <button id="btnConnect" class="wide">🔗 Connect</button>
    <button id="btnStop" class="wide">⛔ Stop</button>
  </div>

  <div style="margin:12px 0;">
    <div class="label">
      <span>Speed</span><span><span id="spdVal">60</span>%</span>
    </div>
    <input id="speed" type="range" min="0" max="100" value="60">
  </div>

  <div class="row">
    <button id="up">↑</button>
  </div>
  <div class="row">
    <button id="left">←</button>
    <button id="right">→</button>
  </div>
  <div class="row">
    <button id="down">↓</button>
  </div>
</div>

<p>Status: <span id="status">DISCONNECTED</span></p>
<pre id="log"></pre>

<script>
let device, server, service, charRW;
const SVC_UUID  = "12345678-1234-5678-1234-56789abcdef0";
const CHAR_UUID = "12345678-1234-5678-1234-56789abcdef1";

const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const spdEl = document.getElementById('speed');
const spdVal = document.getElementById('spdVal');

function log(s){ logEl.textContent = (s + "\n" + logEl.textContent).slice(0,4000); }
function setStatus(s){ statusEl.textContent = s; }

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({
      filters:[{ namePrefix: "M5Basic" }],
      optionalServices:[SVC_UUID]
    });
    device.addEventListener('gattserverdisconnected', () => { setStatus("DISCONNECTED"); });
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SVC_UUID);
    charRW  = await service.getCharacteristic(CHAR_UUID);
    setStatus("CONNECTED");
    log("connected to " + device.name);
  }catch(e){
    log("connect error: " + e);
  }
}

// 送信： [x(int8), y(int8), speed(uint8)] の3バイト
async function send(x, y){
  if(!charRW) return;
  const sp = Number(spdEl.value)|0;
  const b = new Uint8Array(3);
  b[0] = (x<<24)>>24; // int8
  b[1] = (y<<24)>>24; // int8
  b[2] = sp;          // 0..100
  try{ await charRW.writeValueWithoutResponse(b); }
  catch(e){ log("write err: " + e); }
}

function pressBind(elem, vec){
  const down = ()=> send(vec[0], vec[1]);
  const up   = ()=> send(0,0);
  // pointer系でスマホ/PC両対応
  elem.addEventListener('pointerdown', (e)=>{ e.preventDefault(); down(); });
  elem.addEventListener('pointerup',   (e)=>{ e.preventDefault(); up(); });
  elem.addEventListener('pointerleave',(e)=>{ e.preventDefault(); up(); });
  // 念のためタッチ/マウスも
  elem.addEventListener('touchstart',  (e)=>{ e.preventDefault(); down(); }, {passive:false});
  elem.addEventListener('touchend',    (e)=>{ e.preventDefault(); up(); },   {passive:false});
  elem.addEventListener('mousedown',   (e)=>{ e.preventDefault(); down(); });
  elem.addEventListener('mouseup',     (e)=>{ e.preventDefault(); up(); });
}

document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnStop').onclick = ()=> send(0,0);

pressBind(document.getElementById('up'),    [ 0, +100 ]);
pressBind(document.getElementById('down'),  [ 0, -100 ]);
pressBind(document.getElementById('left'),  [ -100, 0 ]);
pressBind(document.getElementById('right'), [ +100, 0 ]);

spdEl.addEventListener('input', ()=>{
  spdVal.textContent = spdEl.value;
  // つまみ変更直後に速度が反映されるよう、静止中でも0,0を投げておく
  send(0,0);
});
</script>
</body>
</html>
